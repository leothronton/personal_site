---
title: '[转帖]win32下lsdyna mpich并行计算试验'
author: leo_thronton
type: post
date: 2011-11-16T21:05:47+00:00
url: /2011/11/16/转帖win32下lsdyna-mpich并行计算试验/
categories:
  - 未分类

---
<div class="PublishedByWebStory-[6]1_71121C579E8E4284A7B091C4D8F72ABF_E4F81B9AAEAF4DCCB56268C1E2583183">
  <p style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:15px 0;padding:0;">
    <span style="widows:2;text-transform:none;text-indent:0;letter-spacing:normal;border-collapse:separate;font:medium 'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif;white-space:normal;orphans:2;color:rgb(0,0,0);word-spacing:0;" class="Apple-style-span"><a href="http://www.magicwolf.cn/study/cae/lsdyna-mpp-mpich.html" target="_blank" rel="noopener noreferrer">win32下lsdyna mpich并行计算试验</a></span>
  </p>
  
  <p style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:15px 0;padding:0;">
    <span style="widows:2;text-transform:none;text-indent:0;letter-spacing:normal;border-collapse:separate;font:medium 'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif;white-space:normal;orphans:2;color:rgb(0,0,0);word-spacing:0;" class="Apple-style-span">今天尝试了lsdyna的并行计算，过程如下：<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 1. 安装virtualbox虚拟机到自己的笔记本，虚拟机中安装xp，克隆成两个，与笔记本构成一个小型PC集群，主机名和IP分别为host1：192.168.1.1(笔记本) ；host2：192.168.1.2(虚拟的xp1)；host3：192.168.1.3(虚拟的xp2)。在这三个主机中创建相同的管理员帐户如 admin , 密码 123<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 2. 在三个主机中安装mpich1.2.5，安装好后打开“任务管理器”中的“进程”选项卡，查看是否有一个mpd.exe的进程。如果有的话说明安装成功。<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 3. 安装好mpich之后还必须对每台主机进行注册才能使用：三个主机分别执行程序目录（默认为C:Program FilesMPICHmpdbin）下的mpiregister.exe，首先会提示输入用户账号(第一步中创建的admin)，然后会提示输入两遍密码，之后会问你是否保持上面的设定。如果选择是，则上面的信息将写入硬盘，否则保存在内存中，再重新启动之后就不存在了，这样mpich才能在网络环境中访问每台主机。<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 4. 下载mpp971_s_R5.1.1_Intelsse_win32_mpich125.zip，解压出来的mpp971.exe是求解器文件，I2a.exe用于转换结果文件，将求解器放置到三个主机中无空格无中文的目录如：C:LSDYNAmpp中，设置系统环境变量LSTC_FILE=license的路径<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 5. 为方便操作，将mpich程序目录(C:Program FilesMPICHmpdbin)加入系统环境变量path中；在3个主机中的C:LSDYNA目录下放一个算例testcase.k，执行以下命令进行单机测试[code]mpirun -np 2 C:LSDYNAmppmpp971.exe i=C:LSDYNAtestcase.k[/code]，normal termination的话再进行多机并行计算，2表示cpu数</span>
  </p>
  
  <p style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:15px 0;padding:0;">
    <span style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" id="more-949"></span>
  </p>
  
  <p style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:15px 0;padding:0;">
    6. 执行并行计算有以下3种方法，前两种必须保证三个主机中的求解器路径相同，k文件路径也相同，如求解器都放在C:LSDYNAmppmpp971.exe ，k文件都放在C:LSDYNAtestcase.k：<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> &nbsp;&nbsp;&nbsp; 方法一：用MPIConfig.exe建立主机列表，执行[code]mpirun -np 6 C:LSDYNAmppmpp971.exe i=C:LSDYNAtestcase.k[/code]这种方法最方便，MPIConfig的设置方法参见附图。<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> &nbsp;&nbsp;&nbsp; 方法二：直接执行[code]mpirun -hosts 3 host1 2 host2 2 host3 2 C:LSDYNAmppmpp971.exe i=C:LSDYNAtestcase.k[/code](第一个3表示host数；后面三个2表示cpu数；host1(2,3)可用ip替换，效果一样的)<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> &nbsp;&nbsp;&nbsp; 方法三：使用配置文件，这种方法最灵活，可设置的参数也较多(请参考mpich的user guide)，我的设置如下：[code] exe C:LSDYNAmppmpp971.exe i=C:LSDYNAtestcase.k<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> hosts<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 192.168.1.1 2<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 192.168.1.2 2<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 192.168.1.3 2<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> [/code]保存成一个文本文件，如cfg.txt<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 执行[code] mpirun cfg.txt [/code]即可<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 当然，以上三个ip也可以用host1，host2，host3替换<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 计算完成后在host1中会生成主要的结果文件，host2，host3中也会生成一些文件。<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 7.若求解器或k文件在三个主机中的安装位置不同，可采用上一步中第三种方法，蛋疼的假设：<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> host1中求解器路径C:LSDYNAmppmpp971.exe ，k文件路径C:LSDYNAtestcase.k；<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> host2中求解器路径C:1mppmpp971.exe ，k文件路径C:1testcase.k；<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> host3中求解器路径C:amppmpp971.exe ，k文件路径C:atestcase.k；<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 配置文件则设置为：[code] exe C:LSDYNAmppmpp971.exe i=C:LSDYNAtestcase.k<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> hosts<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> host1 2<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> host2 2 C:1mppmpp971.exe i=C:1testcase.k<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> host3 2 C:amppmpp971.exe i=C:atestcase.k<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> [/code]host1无求解器路径和k文件路径，则使用第一行&#8221;exe &#8220;后面的路径。<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> host2,3则使用指定路径求解器和文件<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> <strong>结果文件的生成位置</strong>：在host1中执行mpirun cfg.txt命令时，其“当前目录”为结果文件的生成位置，若其他两个主机中不存在该目录，host2和host3中的结果文件会跑到C:windowssystem32里去了，k文件手册中说可设置p=pfile参数改变输出结果的位置，方法3中设置pfile似乎行不通。<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> <strong>当前目录</strong>即命令提示符(cmd)中“>”前面的那串字符表示的目录，如<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> C:Documents and SettingsAdministrator> 表示当前目录为“C:Documents and SettingsAdministrator”<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> mpirun的运行参数，mpiregister及mpiconfig的设置可以看mpich1.2.5程序自带的user guide的第五节Tools；<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> 以上过程均在win32上进行，win32的mpp_dyna不知道支持不支持mpich2，所以安装的是mpich1.2.5，64位的mpp_dyna需要mpich2，所以操作会有所不同，但总体过程相似的。<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> ===========
  </p>
  
  <p style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:15px 0;padding:0;">
    <strong>07.09 补充1</strong>：win32版mpp_dyna可支持mpich2,安装mpich1的dll文件，再安装mpich2即可。mpich2的执行程序换成了mpiexec，配置文件设置方式有所不同(见mpich2 user guide p.5-6)<span class="Apple-converted-space">&nbsp;</span><br style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:0;padding:0;" /> <strong>07.09 补充2</strong>：对比了下mpp版本与smp版本在单机4核8线程(伪8核)64位机器上的执行效率，计算一个DYNA自带算例airbag_deploy.k，mpp版选8核用了15s，选6核用了17s；smp版选8核用了28s，选6核用了27s。结论是1.mpp版本多核计算的效率要明显高于smp版；2.smp版不一定选最高核数时计算效率最高。
  </p>
  
  <p style="font-family:'WenQuanYi Micro Hei Mono', 'WenQuanYi Micro Hei', 'Microsoft Yahei Mono', 'Microsoft Yahei', sans-serif!important;margin:15px 0;padding:0;">
    <strong>07.09 补充3</strong>：mpp计算时不能Ctrl+C,sw*，因为Ctrl+C会导致程序终止。解决方法是：新开一个cmd窗口，cd进入工作目录，键入命令[code] echo sw2 > d3kil[/code]其他命令类似，原理可见《常见问题2.0》第36问。
  </p>
  
  <div class="PoweredByWebStory" style="margin-top:15px;margin-bottom:10px;">
    <a target="_blank" href="http://sns.juziyue.com/webinvite.php?u=337" rel="noopener noreferrer"><img src="http://image.juziyue.com/WebStoryLogo24.png" alt="菊子曰" style="border:0;" /></a>&nbsp;这就是<a target="_blank" href="http://sns.juziyue.com/webinvite.php?u=337" rel="noopener noreferrer">菊子曰</a>啦！
  </div>
</div>